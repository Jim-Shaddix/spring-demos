<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>whoami-table</title>
    <script type="text/javascript" src="js/TableFunctions.js"></script>
    <style>
        #content div {
            display: none;
        }
        #whoami-table div {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Whoami</h1>

    <div id="button-div">
        <button id="json-button">Json</button>
        <button id="pretty-json-button">Pretty-Json</button>
        <button id="tables-button">Tables</button>
        <button id="headers-button">Header-Descriptions</button>
    </div>

    <div id="content">

        <div id = "whoami-table">

            <div id="header-table-div">
                <h3>Request headers received from the servers</h3>
                <table id="header-table"></table>
            </div>

            <div id="request-body-table-div">
                <h3>Request Body</h3>
                <table id="request-body-table"></table>
            </div>

            <div id="url-parts-table-div">
                <h3>Url Parts</h3>
                <table id="url-parts-table"></table>
            </div>

            <div id="remote-info-table-div">
                <h3>Remote Info</h3>
                <table id="remote-info-table"></table>
            </div>

            <div id="authentication-table-div">
                <h3>Auth Info</h3>
                <table id="auth-info-table"></table>
            </div>

            <div id="server-info-table-div">
                <h3>Server Info</h3>
                <table id="server-info-table"></table>
            </div>

        </div>

        <div id = "whoami-raw-json">
            <h3>Json</h3>
            <pre id="raw-json-pre"></pre>
        </div>

        <div id = "whoami-pretty-json">
            <h3>Pretty Json</h3>
            <pre id="pretty-json-pre"></pre>
        </div>

        <div id = "whoami-headers-table">
            <h3>Headers Table</h3>
            <table id="headers-table"></table>
        </div>

    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const jsonBlob = /*[[${jsonBlob}]]*/ {
            "headers": [
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "host",
                    "value": "localhost:8080"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "connection",
                    "value": "keep-alive"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "sec-ch-ua",
                    "value": "\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"99\", \"Google Chrome\";v=\"99\""
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "sec-ch-ua-mobile",
                    "value": "?0"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "sec-ch-ua-platform",
                    "value": "\"macOS\""
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "upgrade-insecure-requests",
                    "value": "1"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "user-agent",
                    "value": "Mozilla (Macintosh; Intel Mac ) Chrome"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "accept",
                    "value": "text/html,application/xhtml+xml"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "sec-fetch-site",
                    "value": "none"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "sec-fetch-mode",
                    "value": "navigate"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "sec-fetch-user",
                    "value": "?1"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "sec-fetch-dest",
                    "value": "document"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "accept-encoding",
                    "value": "gzip, deflate, br"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "accept-language",
                    "value": "en-US,en;q=0.9"
                },
                {
                    "type": null,
                    "short-definition": null,
                    "example": null,
                    "long-definition": null,
                    "name": "cookie",
                    "value": "idea-stuff"
                }
            ],
            "url-parts": {
                "definition": null,
                "request-method": "GET",
                "request-url": "http://localhost:8080/whoami",
                "scheme": "http",
                "protocol": "HTTP/1.1",
                "server-host": "localhost",
                "server-port": "8080",
                "path": "/whoami",
                "query-string": null
            },
            "remote-info": {
                "description": null,
                "definition": null,
                "request-address": "1.1",
                "request-host": "1.1",
                "request-port": "5777"
            },
            "auth": {
                "definition": null,
                "auth-type": null,
                "remoteUser": null,
                "user-principal": "null",
                "definitions": null
            },
            "body": {
                "definition": null,
                "content": "empty-body"
            },
            "server-info": {
                "definition": null,
                "hostname": "mac"
            }
        }/*]]>*/
    </script>

    <script th:inline="javascript">

        ContentType = {
            "TABLE": "TABLE",
            "JSON": "JSON",
            "PRETTY_JSON": "PRETTY_JSON",
            "HEADERS": "HEADERS"
        }

        class ContentBlock {

            type
            containerElement
            enableHandle
            buttonElement

            constructor(type, containerElement, enableHandle, buttonElement) {
                this.type = type
                this.containerElement = containerElement
                this.enableHandle = enableHandle
                this.buttonElement = buttonElement
                this.populate()
            }

            enable() {
                this.containerElement.style.display = "block"
            }

            populate() {
                this.enableHandle();
            }

            disable() {
                this.containerElement.style.display = "none"
            }

        }

        class Content {

            enabledContentBlock;
            allContentBlocks

            constructor(allContentBlocks) {
                this.#setOnClickEvents(allContentBlocks)
                this.allContentBlocks = allContentBlocks;
            }

            #setOnClickEvents(allContentBlocks) {
                for (let i = 0; i < allContentBlocks.length; i++) {
                    let contentBlock = allContentBlocks[i]
                    contentBlock.buttonElement.onclick = () => {
                        this.setContentType(contentBlock.type)
                    }
                }
            }

            setContentType(type) {
                let typeBlock =  this.allContentBlocks.find(block => block.type === type)
                if (this.enabledContentBlock == null) {
                    typeBlock.enable();
                    this.enabledContentBlock = typeBlock;
                } else if (this.enabledContentBlock.type === type) {
                    // do nothing
                } else {
                    this.enabledContentBlock.disable();
                    typeBlock.enable();
                    this.enabledContentBlock = typeBlock;
                }
            }

        }

        function setTableFromKeyValueObject(divElement, columnTitles, keyValueObject) {
            divElement.style.display = "block";
            populateTableFromKeyValuePairs(divElement.querySelector("table"), columnTitles, keyValueObject)
        }

        function displayTableFromKeyValueObject() {
            setTableFromKeyValueObject(document.querySelector("#url-parts-table-div"),     ["Url-Component", "Value"],         jsonBlob["url-parts"])
            setTableFromKeyValueObject(document.querySelector("#request-body-table-div"),  ["Request-Body-Component", "Value"],jsonBlob["body"])
            setTableFromKeyValueObject(document.querySelector("#remote-info-table-div"),   ["Client Info",  "Value"],          jsonBlob["remote-info"])
            setTableFromKeyValueObject(document.querySelector("#authentication-table-div"),["auth-info", "value"],             jsonBlob["auth"])
            setTableFromKeyValueObject(document.querySelector("#server-info-table-div"),   ["server-info", "value"],           jsonBlob["server-info"])
        }

        function displayTableFromArrayObject() {
            let headerTableDiv = document.querySelector("#header-table-div")
            headerTableDiv.style.display = "block";
            let tableElement = document.querySelector("#header-table-div")
            let columnTitles = ["name", "value", "short-definition", "example", "long-definition"]
            let arrayObject = jsonBlob["headers"]
            populateTableFromObjectArray(tableElement, columnTitles, arrayObject)
        }

        function populateTablesContent() {
            displayTableFromKeyValueObject()
            displayTableFromArrayObject()
        }

        function populateRawJsonContent() {
            const jsonDisplayPre = document.querySelector("#raw-json-pre")
            jsonDisplayPre.textContent = jsonDisplayPre.textContent = JSON.stringify(jsonBlob, undefined, 4)
        }

        function populatePrettyJsonContent() {

            // duplicate object (this is one way to perform a deep copy)
            let prettyJsonBlob = JSON.parse(JSON.stringify(jsonBlob));

            let elementsWithDescriptions = ["url-parts", "body", "remote-info", "auth", "server-info"]

            // remove descriptions from elements
            for (let i = 0; i < elementsWithDescriptions.length; i++) {
                let fieldName = elementsWithDescriptions[i]
                delete prettyJsonBlob[fieldName]["description"]
            }

            // parse our header names and values
            let newHeadersObject = {}
            for (let i = 0; i < prettyJsonBlob["headers"].length; i++) {
                newHeadersObject[prettyJsonBlob["headers"][i]["name"]] = prettyJsonBlob["headers"][i]["value"]
            }
            prettyJsonBlob["headers"] = newHeadersObject


            const jsonDisplayPre = document.querySelector("#pretty-json-pre")
            jsonDisplayPre.textContent = jsonDisplayPre.textContent = JSON.stringify(prettyJsonBlob, undefined, 4)
        }

        function populateHeadersContent() {

            // display headers tables
        }

        tableContentBlock      = new ContentBlock(ContentType.TABLE,      document.querySelector("#whoami-table"),        populateTablesContent,    document.querySelector("#tables-button"))
        rawJsonContentBlock    = new ContentBlock(ContentType.JSON,       document.querySelector("#whoami-raw-json"),     populateRawJsonContent,   document.querySelector("#json-button"))
        prettyJsonContentBlock = new ContentBlock(ContentType.PRETTY_JSON,document.querySelector("#whoami-pretty-json"),  populatePrettyJsonContent,document.querySelector("#pretty-json-button"))
        headersContentBlock    = new ContentBlock(ContentType.HEADERS,    document.querySelector("#whoami-headers-table"),populateHeadersContent,   document.querySelector("#headers-button"))

        allContentBlocks = [tableContentBlock, rawJsonContentBlock, prettyJsonContentBlock, headersContentBlock]

        content = new Content(allContentBlocks)

        // sets default content display
        content.setContentType(ContentType.TABLE)

    </script>

</body>
</html>